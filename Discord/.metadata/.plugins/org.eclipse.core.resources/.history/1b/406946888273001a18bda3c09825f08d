package PackageMusic;

import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.TimeUnit;
import java.util.function.BooleanSupplier;
import java.util.function.Consumer;
import java.util.logging.Level;

import com.sedmelluq.discord.lavaplayer.player.AudioPlayer;
import com.sedmelluq.discord.lavaplayer.player.AudioPlayerManager;
import com.sedmelluq.discord.lavaplayer.player.DefaultAudioPlayerManager;
import com.sedmelluq.discord.lavaplayer.source.bandcamp.BandcampAudioSourceManager;
import com.sedmelluq.discord.lavaplayer.source.http.HttpAudioSourceManager;
import com.sedmelluq.discord.lavaplayer.source.local.LocalAudioSourceManager;
import com.sedmelluq.discord.lavaplayer.source.soundcloud.SoundCloudAudioSourceManager;
import com.sedmelluq.discord.lavaplayer.source.twitch.TwitchStreamAudioSourceManager;
import com.sedmelluq.discord.lavaplayer.source.vimeo.VimeoAudioSourceManager;
import com.sedmelluq.discord.lavaplayer.source.youtube.YoutubeAudioSourceManager;

import net.dv8tion.jda.api.JDA;
import net.dv8tion.jda.api.Region;
import net.dv8tion.jda.api.entities.Guild;
import net.dv8tion.jda.api.entities.Icon;
import net.dv8tion.jda.api.entities.TextChannel;
import net.dv8tion.jda.api.entities.VoiceChannel;
import net.dv8tion.jda.api.entities.Guild.ExplicitContentLevel;
import net.dv8tion.jda.api.entities.Guild.MFALevel;
import net.dv8tion.jda.api.entities.Guild.NotificationLevel;
import net.dv8tion.jda.api.entities.Guild.Timeout;
import net.dv8tion.jda.api.entities.Guild.VerificationLevel;
import net.dv8tion.jda.api.events.message.MessageReceivedEvent;
import net.dv8tion.jda.api.exceptions.RateLimitedException;
import net.dv8tion.jda.api.hooks.ListenerAdapter;
import net.dv8tion.jda.api.managers.GuildManager;
import net.dv8tion.jda.api.requests.restaction.AuditableRestAction;

public class MusicPlayer extends ListenerAdapter {

    public static final int DEFAULT_VOLUME = 35; //(0 - 150, where 100 is default max volume)

    private final AudioPlayerManager playerManager;
    private final Map<String, GuildManager> musicManagers;

    public MusicPlayer(){
        java.util.logging.Logger.getLogger("org.apache.http.client.protocol.ResponseProcessCookies").setLevel(Level.OFF);

        this.playerManager = new DefaultAudioPlayerManager();
        playerManager.registerSourceManager(new YoutubeAudioSourceManager());
        playerManager.registerSourceManager(new SoundCloudAudioSourceManager(false, null, null, null, null));
        playerManager.registerSourceManager(new BandcampAudioSourceManager());
        playerManager.registerSourceManager(new VimeoAudioSourceManager());
        playerManager.registerSourceManager(new TwitchStreamAudioSourceManager());
        playerManager.registerSourceManager(new HttpAudioSourceManager());
        playerManager.registerSourceManager(new LocalAudioSourceManager());

        musicManagers = new HashMap<String, GuildManager>();
    }
    
    private GuildManager getMusicManager(Guild guild){
    	
        String guildId = guild.getId();
        GuildManager guildManager = musicManagers.get(guildId);
        
        if (guildManager == null)
        {
            synchronized (musicManagers)
            {
            	guildManager = musicManagers.get(guildId);
                if (guildManager == null)
                {
                	guildManager = new mus();
                	
                	
                   // mng = new GuildManager(playerManager);
					guildManager.player.setVolume(DEFAULT_VOLUME);
                    musicManagers.put(guildId, guildManager);
                }
            }
        }
        return guildManager;
    }
    
    
    
    public void onMessageReceived(MessageReceivedEvent event) {
    	Guild guild = event.getGuild();
    	GuildManager mng = getMusicManager(guild);
    	AudioPlayer player = mng.player;
    	String[] command = event.getMessage().getContentDisplay().split(" ", 2);
    	
    	try
        {
            int newVolume = Math.max(10, Math.min(100, Integer.parseInt(command[1])));
            int oldVolume = player.getVolume();
            player.setVolume(newVolume);
            event.getChannel().sendMessage("Player volume changed from `" + oldVolume + "` to `" + newVolume + "`").queue();
        }
        catch (NumberFormatException e)
        {
            event.getChannel().sendMessage("`" + command[1] + "` is not a valid integer. (10 - 100)").queue();
        }
    }
}